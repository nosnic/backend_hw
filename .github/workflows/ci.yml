name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      db:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      rabbitmq:
        image: rabbitmq:3-management
        env:
          RABBITMQ_DEFAULT_USER: guest
          RABBITMQ_DEFAULT_PASS: guest
        ports:
          - 5672:5672
          - 15672:15672
        options: >-
          --health-cmd "rabbitmq-diagnostics -q ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov pytest-mock httpx

      - name: Wait for services
        run: |
          echo "Waiting for PostgreSQL..."
          timeout 60 bash -c 'until pg_isready -h localhost -p 5432; do sleep 1; done'
          echo "PostgreSQL is ready!"
          
          echo "Waiting for RabbitMQ..."
          timeout 60 bash -c 'until curl -s http://localhost:15672 > /dev/null; do sleep 1; done'
          echo "RabbitMQ is ready!"

      - name: Run tests with coverage
        env:
          DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/postgres
          RABBITMQ_URL: amqp://guest:guest@localhost/
        run: |
          python -m pytest app/test_main.py -v \
            --cov=app \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=json \
            --cov-fail-under=90 \
            --asyncio-mode=auto \
            --junitxml=junit.xml \
            2>&1 | tee pytest-output.txt

      - name: Generate Test Summary
        if: always()
        run: |
          echo "## üß™ Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # –ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ pytest
          if [ -f pytest-output.txt ]; then
            PASSED=$(grep -oP '\d+(?= passed)' pytest-output.txt | tail -1 || echo "0")
            FAILED=$(grep -oP '\d+(?= failed)' pytest-output.txt | tail -1 || echo "0")
            SKIPPED=$(grep -oP '\d+(?= skipped)' pytest-output.txt | tail -1 || echo "0")
            WARNINGS=$(grep -oP '\d+(?= warning)' pytest-output.txt | tail -1 || echo "0")
            
            echo "### Test Statistics" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| ‚úÖ Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| ‚ùå Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
            echo "| ‚è≠Ô∏è Skipped | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
            echo "| ‚ö†Ô∏è Warnings | $WARNINGS |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # –ü–∞—Ä—Å–∏–Ω–≥ –ø–æ–∫—Ä—ã—Ç–∏—è –∏–∑ coverage.json
          if [ -f coverage.json ]; then
            TOTAL_COV=$(python3 -c "import json; data=json.load(open('coverage.json')); print(f\"{data['totals']['percent_covered']:.2f}\")")
            TOTAL_STMTS=$(python3 -c "import json; data=json.load(open('coverage.json')); print(data['totals']['num_statements'])")
            COVERED_STMTS=$(python3 -c "import json; data=json.load(open('coverage.json')); print(data['totals']['covered_lines'])")
            MISSING_STMTS=$(python3 -c "import json; data=json.load(open('coverage.json')); print(data['totals']['missing_lines'])")
            
            echo "### üìä Code Coverage" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –±–µ–π–¥–∂–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –ø–æ–∫—Ä—ã—Ç–∏—è
            if (( $(echo "$TOTAL_COV >= 90" | bc -l) )); then
              BADGE_COLOR="brightgreen"
              EMOJI="üü¢"
            elif (( $(echo "$TOTAL_COV >= 80" | bc -l) )); then
              BADGE_COLOR="green"
              EMOJI="üü°"
            elif (( $(echo "$TOTAL_COV >= 70" | bc -l) )); then
              BADGE_COLOR="yellow"
              EMOJI="üü†"
            else
              BADGE_COLOR="red"
              EMOJI="üî¥"
            fi
            
            echo "#### $EMOJI Total Coverage: **${TOTAL_COV}%**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "![Coverage](https://img.shields.io/badge/coverage-${TOTAL_COV}%25-${BADGE_COLOR})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Total Statements | $TOTAL_STMTS |" >> $GITHUB_STEP_SUMMARY
            echo "| Covered | $COVERED_STMTS |" >> $GITHUB_STEP_SUMMARY
            echo "| Missing | $MISSING_STMTS |" >> $GITHUB_STEP_SUMMARY
            echo "| **Coverage %** | **${TOTAL_COV}%** |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # –î–µ—Ç–∞–ª—å–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ –ø–æ —Ñ–∞–π–ª–∞–º
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>üìÅ Coverage by File</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| File | Statements | Missing | Coverage |" >> $GITHUB_STEP_SUMMARY
            echo "|------|------------|---------|----------|" >> $GITHUB_STEP_SUMMARY
            
            python3 -c '
import json
with open("coverage.json") as f:
    data = json.load(f)
    for file_path, file_data in sorted(data["files"].items()):
        if file_path.startswith("app/"):
            file_name = file_path
            stmts = file_data["summary"]["num_statements"]
            missing = file_data["summary"]["missing_lines"]
            coverage = file_data["summary"]["percent_covered"]

            if coverage >= 90:
                emoji = "üü¢"
            elif coverage >= 80:
                emoji = "üü°"
            elif coverage >= 70:
                emoji = "üü†"
            else:
                emoji = "üî¥"

            print(f"| {file_name} | {stmts} | {missing} | {emoji} {coverage:.1f}% |")
' >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
          if [ -f pytest-output.txt ]; then
            DURATION=$(grep -oP '\d+\.\d+(?=s)' pytest-output.txt | tail -1 || echo "N/A")
            echo "‚è±Ô∏è **Test Duration:** ${DURATION}s" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "üì¶ **Artifacts:**" >> $GITHUB_STEP_SUMMARY
          echo "- Coverage HTML Report (available in workflow artifacts)" >> $GITHUB_STEP_SUMMARY

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Upload coverage HTML
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: htmlcov/
          retention-days: 30

  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort mypy

      - name: Run flake8
        continue-on-error: true
        run: |
          flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 app/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Check code formatting with black
        continue-on-error: true
        run: |
          black --check app/

      - name: Check import sorting with isort
        continue-on-error: true
        run: |
          isort --check-only app/

  docker-build:
    runs-on: ubuntu-latest
    needs: [test]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -t backend-app:test .

      - name: Test Docker image
        run: |
          docker images backend-app:test