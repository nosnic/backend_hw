name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      rabbitmq:
        image: rabbitmq:3-management
        env:
          RABBITMQ_DEFAULT_USER: guest
          RABBITMQ_DEFAULT_PASS: guest
        ports:
          - 5672:5672
          - 15672:15672
        options: >-
          --health-cmd "rabbitmq-diagnostics -q ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov pytest-mock httpx

      - name: Wait for services
        run: |
          echo "Waiting for PostgreSQL..."
          for i in {1..60}; do
            if pg_isready -h localhost -p 5432 2>/dev/null; then
              echo "PostgreSQL is ready!"
              break
            fi
            sleep 1
          done
          
          echo "Waiting for RabbitMQ..."
          for i in {1..60}; do
            if curl -s http://localhost:15672 > /dev/null 2>&1; then
              echo "RabbitMQ is ready!"
              break
            fi
            sleep 1
          done

      - name: Run tests with coverage
        env:
          DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/postgres
          RABBITMQ_URL: amqp://guest:guest@localhost:5672/
        run: |
          set -o pipefail
          python -m pytest app/tests/ -v \
            --cov=app \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=json \
            --cov-fail-under=90 \
            --asyncio-mode=auto \
            --junitxml=junit.xml 2>&1 | tee pytest-output.txt

      - name: Generate Test Summary
        if: always()
        run: |
          echo "## üß™ Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # –ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ pytest
          if [ -f pytest-output.txt ]; then
            PASSED=$(grep -E '[0-9]+ passed' pytest-output.txt | tail -1 | grep -oE '[0-9]+' || echo "0")
            FAILED=$(grep -E '[0-9]+ failed' pytest-output.txt | tail -1 | grep -oE '[0-9]+' || echo "0")
            SKIPPED=$(grep -E '[0-9]+ skipped' pytest-output.txt | tail -1 | grep -oE '[0-9]+' || echo "0")
            WARNINGS=$(grep -E '[0-9]+ warnings' pytest-output.txt | tail -1 | grep -oE '[0-9]+' || echo "0")
            
            echo "### Test Statistics" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| ‚úÖ Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| ‚ùå Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
            echo "| ‚è≠Ô∏è Skipped | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
            echo "| ‚ö†Ô∏è Warnings | $WARNINGS |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # –ü–∞—Ä—Å–∏–Ω–≥ –ø–æ–∫—Ä—ã—Ç–∏—è –∏–∑ coverage.json
          if [ -f coverage.json ]; then
            python3 << 'EOF'
import json
import sys

try:
    with open('coverage.json', 'r') as f:
        data = json.load(f)

    total_cov = data['totals']['percent_covered']
    total_stmts = data['totals']['num_statements']
    covered_stmts = data['totals']['covered_lines']
    missing_stmts = data['totals']['missing_lines']
    
    print(f"TOTAL_COV={total_cov:.2f}")
    print(f"TOTAL_STMTS={total_stmts}")
    print(f"COVERED_STMTS={covered_stmts}")
    print(f"MISSING_STMTS={missing_stmts}")
    
    # –î–µ—Ç–∞–ª—å–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ –ø–æ —Ñ–∞–π–ª–∞–º
    file_coverage = []
    for file_path, file_data in sorted(data.get("files", {}).items()):
        if file_path.startswith("app/"):
            coverage = file_data["summary"]["percent_covered"]
            stmts = file_data["summary"]["num_statements"]
            missing = file_data["summary"]["missing_lines"]
            file_coverage.append(f"{file_path}|{stmts}|{missing}|{coverage:.1f}")

    print("FILE_COVERAGE=" + ";".join(file_coverage))
except Exception as e:
    print(f"ERROR={str(e)}", file=sys.stderr)
    sys.exit(1)
EOF
          
            if [ -n "$TOTAL_COV" ]; then
              echo "### üìä Code Coverage" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –±–µ–π–¥–∂–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –ø–æ–∫—Ä—ã—Ç–∏—è
              if (( $(echo "$TOTAL_COV >= 90" | bc -l) )); then
                BADGE_COLOR="brightgreen"
                EMOJI="üü¢"
              elif (( $(echo "$TOTAL_COV >= 80" | bc -l) )); then
                BADGE_COLOR="green"
                EMOJI="üü°"
              elif (( $(echo "$TOTAL_COV >= 70" | bc -l) )); then
                BADGE_COLOR="yellow"
                EMOJI="üü†"
              else
                BADGE_COLOR="red"
                EMOJI="üî¥"
              fi

              echo "#### $EMOJI Total Coverage: **${TOTAL_COV}%**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "![Coverage](https://img.shields.io/badge/coverage-${TOTAL_COV}%25-${BADGE_COLOR})" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
              echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
              echo "| Total Statements | $TOTAL_STMTS |" >> $GITHUB_STEP_SUMMARY
              echo "| Covered | $COVERED_STMTS |" >> $GITHUB_STEP_SUMMARY
              echo "| Missing | $MISSING_STMTS |" >> $GITHUB_STEP_SUMMARY
              echo "| **Coverage %** | **${TOTAL_COV}%** |" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # –î–µ—Ç–∞–ª—å–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ –ø–æ —Ñ–∞–π–ª–∞–º
              if [ -n "$FILE_COVERAGE" ]; then
                echo "<details>" >> $GITHUB_STEP_SUMMARY
                echo "<summary>üìÅ Coverage by File</summary>" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "| File | Statements | Missing | Coverage |" >> $GITHUB_STEP_SUMMARY
                echo "|------|------------|---------|----------|" >> $GITHUB_STEP_SUMMARY
                
                IFS=';' read -ra FILES <<< "$FILE_COVERAGE"
                for file_info in "${FILES[@]}"; do
                  IFS='|' read -ra PARTS <<< "$file_info"
                  file_name="${PARTS[0]}"
                  stmts="${PARTS[1]}"
                  missing="${PARTS[2]}"
                  coverage="${PARTS[3]}"
                  
                  if (( $(echo "$coverage >= 90" | bc -l) )); then
                    emoji="üü¢"
                  elif (( $(echo "$coverage >= 80" | bc -l) )); then
                    emoji="üü°"
                  elif (( $(echo "$coverage >= 70" | bc -l) )); then
                    emoji="üü†"
                  else
                    emoji="üî¥"
                  fi
                  
                  echo "| $file_name | $stmts | $missing | $emoji $coverage% |" >> $GITHUB_STEP_SUMMARY
                done
                
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "</details>" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          fi
          
          # –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
          if [ -f pytest-output.txt ]; then
            DURATION=$(grep -E '[0-9]+\.[0-9]+s' pytest-output.txt | tail -1 | grep -oE '[0-9]+\.[0-9]+' || echo "N/A")
            echo "‚è±Ô∏è **Test Duration:** ${DURATION}s" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # –°—Å—ã–ª–∫–∞ –Ω–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "üì¶ **Artifacts:**" >> $GITHUB_STEP_SUMMARY
          echo "- Coverage HTML Report (available in workflow artifacts)" >> $GITHUB_STEP_SUMMARY

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Upload coverage HTML
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: htmlcov/
          retention-days: 30

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            pytest-output.txt
            junit.xml
          retention-days: 30

  lint:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort mypy

      - name: Run flake8
        continue-on-error: true
        run: |
          flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 app/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Check code formatting with black
        continue-on-error: true
        run: |
          black --check app/

      - name: Check import sorting with isort
        continue-on-error: true
        run: |
          isort --check-only app/

  docker-build:
    runs-on: ubuntu-latest
    needs: [test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -t backend-app:test .

      - name: Test Docker image
        run: |
          docker images backend-app:test